<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What's your weather like</title>
    <link rel="stylesheet" href="../static/css/mood.css">
    <script>
        let curIcon = ''                    // ì•„ì´ì½˜ ë³€ìˆ˜
        let w_type = `{{ weather_type }}`   // ë‚ ì”¨ ë³€ìˆ˜
        let username = sessionStorage.getItem("username"); // ì„¸ì…˜ ì •ë³´
        let isEmpty = true                                 // ì„¸ì…˜ ì •ë³´ ì¡´ì¬ ì—¬ë¶€

        window.onload = function () {
            get_weather_type(w_type)        // ë‚ ì”¨ ë°°ê²½ ì ìš© í•¨ìˆ˜ í˜¸ì¶œ
            isEmpty = set_page(username)    // ì„¸ì…˜ ì •ë³´ í™•ì¸ í•¨ìˆ˜

            listing()
            document.getElementById('date').value = new Date().toISOString().substring(0, 10);
            const moodIconArr = document.getElementsByClassName('mood_span')
            Array.prototype.forEach.call(moodIconArr, a => {
                a.addEventListener('click', () => {
                    Array.prototype.map.call(moodIconArr, b => b.classList.remove('active'))
                    a.classList.add('active');
                    curIcon = a.innerText
                })
            })
        }

        function listing() {
            fetch('/login').then((res) => res.json()).then((data) => {
                let rows = data['result']
                rows.forEach((a) => {
                    let comment = a['comment']
                    $('#cards-box').append(temp_html)
                })
            })
        }

        function posting(isEmpty) {
            // ì„¸ì…˜ ì •ë³´ê°€ ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ í¬ìŠ¤íŒ… ë™ì‘
            console.log(isEmpty)
            if(!isEmpty){
                let date = document.querySelector('#date').value
                let text = document.querySelector('#text').value
                let moodIcon = curIcon
                let formData = new FormData();
                formData.append("date_give", date);
                formData.append("comment_give", text);
                formData.append("moodIcon_give", moodIcon);
                formData.append("user_nm_give", username);
                fetch('/mood', { method: "POST", body: formData }).then((res) => res.json()).then((data) => {
                    console.log(data['msg'])
                    alert(data['msg'])
                    // window.location.reload()
                })
            } else {
                alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.")
            }
        }

        /*
            ë‚ ì”¨ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜. ë‚ ì”¨ê°’ì— ë”°ë¼ í™”ë©´ ë³€ê²½
        */
        function get_weather_type(weather_type) {
            let w_type = weather_type;
            if (w_type.includes('ë§‘ìŒ')) {
                document.getElementById("b_viedo").setAttribute('src', "../static/video/weather/w_sunny.mp4")
            } else if (w_type.includes('íë¦¼') || w_type.includes('êµ¬ë¦„') || w_type.includes('íë¦¬ê³ ') || w_type.includes('íë¦°')) {
                document.getElementById("b_viedo").setAttribute('src', "../static/video/weather/w_partly_cloudy.mp4")
            } else if (w_type.includes('ë¹„') || w_type.includes('ì†Œë‚˜ê¸°') || w_type.includes('ê°•ìš°') || w_type.includes('ë‡Œìš°')) {
                document.getElementById("b_viedo").setAttribute('src', "../static/video/weather/w_rain_train.mp4")
            } else {
                document.getElementById("b_viedo").setAttribute('src', "../static/video/ocean.mp4")
            }
        }

        /*
            ì„¸ì…˜ ì •ë³´ì— ë”°ë¼ í™”ë©´ ì„¸íŒ… ë³€ê²½ í•¨ìˆ˜. ì„¸ì…˜ ì •ë³´ê°€ ìˆìœ¼ë©´ ì €ì¥ê°€ëŠ¥, ì•„ë‹ˆë©´ ë¶ˆê°€.
         */
        function set_page(username) {
            let isEmpty = true
            if (username == "" || username == null || username == undefined || (username != null && typeof username == "object" && !Object.keys(username).length)) {
                console.log("############ ì„¸ì…˜ ì—†ìŒ")
                isEmpty = true
            } else {
                console.log("############ ì„¸ì…˜ ìˆìŒ")
                isEmpty = false
            }
            return isEmpty
        }

    </script>
</head>

<body>
    <!-- common/layout.html -->
    {% extends "common/layout.html" %}
    {% block content %}
    <video src="../static/video/ocean.mp4" autoplay loop muted class="b_video" id="b_viedo"></video>
    <!-- home.html -->
    <div class="container">
        <div class="main_wrap">
            <h2>ì§€ê¸ˆ ë‹¹ì‹ ì˜ ê¸°ë¶„ì€?</h2>

            <div class="mood_box">
                <span class="mood_span">ğŸ˜€</span>
                <span class="mood_span">ğŸ˜†</span>
                <span class="mood_span">ğŸ˜«</span>
                <span class="mood_span">ğŸ˜•</span>
                <span class="mood_span">ğŸ¤¬</span>
            </div>

            <label for="date" class="date_Wrap">
                ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš” :
                <input type="date" id="date" max="2023-12-31" min="2023-03-27">
            </label>

            <label for="text">
                <textarea name="text" id="text" cols="9" rows="9"></textarea>
            </label>

            <button id="mood_btn" class="submit_btn" type="button" onclick="posting()">
                ì €ì¥í•˜ê¸°
            </button>
        </div>
        <!-- {% include "common/pop.html"  ignore missing %} -->
    </div>
    {% endblock %}
</body>

</html>